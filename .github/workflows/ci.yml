name: CI # このワークフローの表示名

on:
  pull_request: # 全てのブランチへのPRで実行
  push:
    branches: [ main ] # mainブランチへのpushで実行

jobs:
  # セキュリティチェック
  scan_ruby: # ジョブの識別名（任意の名前)
    runs-on: ubuntu-latest # このジョブを実行する仮想環境

    steps:
      - name: Checkout code # GitHubリポジトリのコードを仮想マシン上にコピー（クローン）する
        uses: actions/checkout@v4 #「GitHubが提供する「コードをチェックアウトする処理」のバージョン4を使う

      - name: Set up Ruby # 仮想マシンにRuby環境をインストール(Gemのインストールやbundlerの準備を行う)
        uses: ruby/setup-ruby@v1 # Ruby公式が提供するRubyセットアップアクション
        with:
          ruby-version: .ruby-version # ファイルに書かれているバージョンを自動で読み取る
          bundler-cache: true # 2回目以降の実行が高速化される

      - name: Scan for security vulnerabilities
        run: bundle exec brakeman --no-pager

  # Lintチェック
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true

      - name: Lint code for consistent style
        run: bundle exec rubocop

  # テスト実行
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:18 # Docker Hubから公式のPostgreSQLイメージ（バージョン18）を取得、GitHub Actionsの仮想マシン内でPostgreSQLコンテナを起動、テスト実行時に使用する一時的なデータベース環境
        env:
          POSTGRES_USER: postgres # DATABASE_URLで接続する際に必要な初期設定
          POSTGRES_PASSWORD: password
          POSTGRES_DB: okan_test
        ports:
          - 5432:5432
        options: >- # 下のコマンドの説明→ PostgreSQLが起動して接続可能か確認、10秒ごとにヘルスチェック実行、チェックが5秒以内に完了しなければタイムアウト、5回まで失敗を許容
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      chrome:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --health-cmd "curl -f http://localhost:4444/status || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      RAILS_ENV: test # config/environments/test.rbの設定が使われる
      RAILS_TEST_KEY: ${{ secrets.RAILS_TEST_KEY }}
      DATABASE_URL: postgres://postgres:password@localhost:5432/okan_test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: .ruby-version
          bundler-cache: true
      # Node.jsのセットアップ
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'
          cache: 'yarn'

      # Yarnの依存関係をインストール
      - name: Install JavaScript dependencies
        run: yarn install --frozen-lockfile

      - name: Install dependencies
        run: | # 下のコマンドの説明→　System Specで使用、PostgreSQLに接続するためのクライアントツール、pg gemのビルドに必要、画像処理ライブラリ
          sudo apt-get update
          sudo apt-get install --no-install-recommends -y \
            google-chrome-stable \
            postgresql-client \
            libpq-dev \
            libvips

      # Tailwind CSSのビルド
      - name: Precompile assets
        run: bundle exec rails assets:precompile

      - name: Set up Database
        run: |
          bundle exec rails db:create
          bundle exec rails db:schema:load

      - name: Debug-credentials
        run: |
          echo "RAILS_ENV: $RAILS_ENV"
          echo "RAILS_TEST_KEY exists: ${{ secrets.RAILS_TEST_KEY != '' }}"
          bundle exec rails runner "puts Rails.application.credentials.active_record_encryption.inspect"

      - name: Run RSpec
        run: bundle exec rspec

      - name: Keep screenshots from failed system tests
        uses: actions/upload-artifact@v4 # ファイルをGitHub Actions上に保存
        if: failure()
        with:
          name: screenshots
          path: tmp/capybara
          if-no-files-found: ignore
          retention-days: 7 # 保存期間を7日間に設定

  # デプロイ（mainブランチへのpush時のみ、かつ全てのCIが成功した場合のみ実行）
  deploy:
    needs: [scan_ruby, lint, test] # この3つのジョブが全て成功した場合のみ実行
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' # mainへのpushの場合のみ
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render Deploy
        run: |
          curl -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }}

      - name: Notify deployment started
        run: echo "✅ Deployment to Render has been triggered successfully!"