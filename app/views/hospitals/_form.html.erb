<%= form_with model: hospital do |f| %>
  <%= render "shared/error_messages", object: f.object %>
  <!-- 病院情報セクション -->
  <div class="bg-white rounded-lg shadow-sm p-3 mb-6">
    <div class="mb-2">
      <%= f.label :name, class: "block font-bold mb-1" %>
      <%= f.text_field :name, class: form_field_class(f.object, :name) %>
    </div>
    <div class="mb-2">
      <%= f.label :description, class: "block font-bold mb-1" %>
      <%= f.text_area :description, rows: 2, class: "textarea textarea-bordered w-full #{f.object.errors[:description].any? ? 'textarea-error bg-red-100' : 'bg-white'}" %>
    </div>
    <!-- 診療時間 -->
    <div class="mb-6">
      <div class="flex">
        <h2 class="text-lg font-bold">診療時間</h2>
        <span class="text-gray-400 ml-1">(休診の場合は空欄)</span>
      </div>
      <div class="space-y-4">
        <% # 曜日順にソート
           schedules_by_day = @hospital.hospital_schedules
                                       .sort_by { |s| [s.day_of_week.to_i, s.period.to_i] }
                                       .group_by(&:day_of_week) %>
        <% HospitalSchedule.day_of_weeks.keys.each do |day| %>
          <% schedules = schedules_by_day[day] || [] %>
          <% morning = schedules.find { |s| s.period == "morning" } %>
          <% afternoon = schedules.find { |s| s.period == "afternoon" } %>
          <div class="border border-gray-300 rounded-lg p-3 bg-white">
            <!-- 曜日 -->
            <div class="font-bold text-gray-800 text-center">
              <%= HospitalSchedule.day_of_weeks_i18n[day.to_sym] %>
            </div>
            <!-- 午前 -->
            <div class="mb-3 flex">
              <span class="text-xs text-gray-600 mr-4">午前</span>
              <%= f.fields_for :hospital_schedules, morning do |sf| %>
                <%= sf.hidden_field :id if sf.object.persisted? %>
                <%= sf.hidden_field :day_of_week %>
                <%= sf.hidden_field :period %>
                <div class="flex items-center gap-1 text-xs">
                  <!-- 午前開始時間 -->
                  <%= sf.select :start_time,
                                options_for_select(morning_time_options, sf.object.start_time&.strftime("%H:%M")),
                                { include_blank: true },
                                class: "w-24 border #{sf.object.errors[:start_time].any? ? "border-red-500" : "border-gray-300"} rounded px-2 py-1" %>
                  <span class="text-gray-500">〜</span>
                  <!-- 午前終了時間 -->
                  <%= sf.select :end_time,
                                  options_for_select(morning_time_options, sf.object.end_time&.strftime("%H:%M")),
                                  { include_blank: true },
                                  class: "w-24 border #{sf.object.errors[:end_time].any? ? "border-red-500" : "border-gray-300"} rounded px-2 py-1" %>
                </div>
              <% end %>
            </div>
            <!-- 午後 -->
            <div class="mb-3 flex">
              <span class="text-xs text-gray-600 mr-4">午後</span>
              <%= f.fields_for :hospital_schedules, afternoon do |sf| %>
                <%= sf.hidden_field :id if sf.object.persisted? %>
                <%= sf.hidden_field :day_of_week %>
                <%= sf.hidden_field :period %>
                <div class="flex items-center gap-1 text-xs">
                  <!-- 午後開始時間 -->
                  <%= sf.select :start_time,
                                options_for_select(afternoon_time_options, sf.object.start_time&.strftime("%H:%M")),
                                { include_blank: true },
                                class: "w-24 border #{sf.object.errors[:start_time].any? ? "border-red-500" : "border-gray-300"} rounded px-2 py-1" %>
                  <span class="text-gray-500">〜</span>
                  <!-- 午後終了時間 -->
                  <%= sf.select :end_time,
                                options_for_select(afternoon_time_options, sf.object.end_time&.strftime("%H:%M")),
                                { include_blank: true },
                                class: "w-24 border #{sf.object.errors[:end_time].any? ? "border-red-500" : "border-gray-300"} rounded px-2 py-1" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
    <!-- 送信ボタン -->
    <div class="flex justify-center">
      <%= f.submit nil, class: "btn btn-primary" %>
    </div>
  <% end %>